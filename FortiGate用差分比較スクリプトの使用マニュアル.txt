                 ################################################################
                 #                                                              #
                 #   FortiGate用コンフィグ差分比較スクリプトの使用マニュアル    #
                 #                                                              #
                 ################################################################

【用途と利点】
コンフィグファイルの差分比較を非常に高速にかつ正確に行うアシストツールです。トップレベルのブロックごとにコンフィグファイルから切り出してひとつひとつのブロックについてdiffをとりますのでWinMergeやDFを使った手作業よりもミスがなく正確です。バージョンが異なることで何の機能が削除されたのか、何の機能が新しく加わったのか、従来の残されている機能の変更点は何かを簡単に洗い出すことができます。
人手で差分比較を行うとミスが起こりやすい上、バージョンによっては大量の差分が発生することがあり、バージョンごとに人を割り当てていると割り当てる仕事の量の不均衡が生じます。この差分比較スクリプトを使用することでその問題も解決します。
スクリプトで洗い出された結果はエクセルファイルにも書き出すための補助スクリプトを同梱してありますので、そちらもご利用ください。
このスクリプトを使って、手作業だと2,3人がかりでやってもなかなか終わらない差分比較作業を1人で10分で終わらせましょう！
空いた時間で他の仕事をするもよし、コーヒーを飲んでゆっくりするもよし、です。
Don't kill the time by your wasteful boring works.


【前提条件】
・任意のLinuxサーバに自分のアカウントを持っていてSSHでたたけること
・比較をする古いコンフィグファイルと新しいコンフィグファイルを自分のアカウントにアップロードしてあること
・Perl5以上がサーバにインストールされていること(シェルでwhich perlとたたいて/usr/bin/perlと表示されていますか？)
・(エクセル形式にまとめたい場合は)任意のバージョンのMicrosoft Office Excelが自分のマシンにインストールされていること

＜下準備＞
コンフィグを処理するためのスクリプト"block_splitter.pl"と"format.pl"を~/config_processorに配置しましょう。


＜作業＞
1 　　古いほうのコンフィグ(仮にファイル名をconfigAとする) と新しいほうのコンフィグ(仮にファイル名をcofigBとする)を比較スクリプトと同じディレクトリにアップロードします。
　　　アップロードができたことを確認するために次のコマンドを実行してください。
　　　
　　　cd ~/config_processor && ls configA && ls configB
　　　それぞれのコンフィグの名前が表示されたら成功です。エラーが表示された場合はファイル名が誤っていないか、正しい場所にアップロードされているかを確認してからもう一度実行してください。
　　　
2 　　各々のコンフィグの差分をとります。次のコマンドを実行してください。
　　　
　　　perl block_splitter.pl configA configB
　　　数秒で処理が完了し、何も表示されなければ成功です。
　　　
3 　　コンフィグからブロックごとに分けたファイルと、それぞれの差分比較をしたファイルを格納しているディレクトリが生成されるはずです。次のコマンドを1つずつ実行して存在を確かめてください。全て実行しても何も表示されなければ成功です。
　　　
　　　[ -e configA_DIR/ ] || echo 'It does not exist'
　　　[ -e configB_DIR/ ] || echo 'It does not exist'
　　　[ -e configA-configB_DIFF_DIR/ ] || echo 'It does not exist'
　　　
4 　　それぞれのコンフィグから何の機能が削除されたか、または新しく加わったかを確認するための一覧を作成します。
　　　次のコマンドをそれぞれ実行してください。
　　　
　　　ls configA_DIR > LIST_configA && [ -e LIST_configA ] || echo 'It does not exist'
　　　ls configB_DIR > LIST_configB && [ -e LIST_configB ] || echo 'It does not exist'
　　　ls configA-configB_DIFF_DIR > DIFF_configA-configB && [ -e DIFF_configA-configB ] || echo 'It does not exist'
　　　
　　　何も表示されなければ成功です。続いて次のコマンドを実行してください。
　　　
　　　diff LIST_configA LIST_configB | grep '^>' | sed -e 's/^>\s*//' > ADD_configA-configB
　　　diff LIST_configA LIST_configB | grep '^<' | sed -e 's/^<\s*//' > DEL_configA-configB
　　　
　　　何も表示されなければ成功です。
　　　このとき、新機能の数を調べるには wc -l ADD_configA-configB | awk '{print $1}' を実行します。
　　　このとき、削除された機能の数を調べるには wc -l DEL_configA-configB | awk '{print $1}' を実行します。
　　　
5 　　ここからはExcelファイルにするための作業です。それぞれ以下のコマンドを実行してください。
　　　perl format.pl ADD_configA-configB
　　　perl format.pl DEL_configA-configB
　　　perl format.pl DIFF_configA-configB
　　　
　　　実行して何も表示されなければ成功です。
　　　
6 　　5で実行したコマンドでファイルが3つ作られたはずです。確認のために以下のコマンドを実行してください。
　　　[ -e FOREXCEL_ADD_ADD_configA-configB ] || echo 'It does not exist'
　　　[ -e FOREXCEL_DEL_DEL_configA-configB ] || echo 'It does not exist'
　　　[ -e FOREXCEL_CHN_DIFF_configA-configB ] || echo 'It does not exist'
　　　[ -e FOREXCEL_CHN_DIFF_configA-configB ] || echo 'It does not exist'
　　　
　　　実行して何も表示されなければ成功です。
　　　
7 　　6で確認した3つのファイルを自分のマシンにSCPやSFTPなどを使ってダウンロードしてください。
8 　　Microsoft Excelを開きます。Excel 2013を例に操作方法を説明します。
　　　
　　　
9 　　"空白のブック"でブックを新規作成します。
10　　アクティブセルがA1になっていることを確認します。
10　　メニューバーの[データ]をクリックします。
11　　メニューのなかに左から順に「Accessデータベース」「Webクエリ」「テキストファイル」「その他のデータソース」が見当たりますので、「テキストファイル」をクリックします。
12　　ダウンロードしたファイルを選びます。ファイルを選ぶ順番は関係ありません。
13　　[開く]でファイルを開くと、テキストウィザードが開きます。
　　　「元のデータの形式」のところに「カンマやタブなどの区切り文字によってフィールドごとに区切られたデータ」
　　　とありますのでここのラジオボタンを押してください。
14　　取り込み開始行は1、文字コードはUnicode(UTF-8)を選択してください。そうしたら、プレビューをみて、文字化けがないことを確認します。
15　　「次へ」をクリックします。そうしたら、「区切り文字」のところにチェックがつけられます。全てのチェックを外して「カンマ」だけをチェックしてください。次に「完了」をクリックします。
16　　「データの取り込み」が選べます。今回は真新しいブックに貼り付けるので、このまま「OK」をクリックしてください。
17　　正しく貼り付けられたことを確認したら終了です。他のデータを貼り付ける場合はシートを新しく作成して12から繰り返してください。


＜留意事項＞
作業後はサーバにコンフィグファイルを置いておく必要はありません。不要なったら念のためにrmコマンドで削除しておきましょう。